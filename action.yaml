name: 'Setup Docker Cross-platform'
description: 'Installs Docker in Windows WSL and macOS Colima'

branding:
  icon: 'box'
  color: 'blue'

outputs:
  docker-host:
    description: 'Docker host connection string'
    value: ${{ steps.set-docker-host.outputs.docker-host }}

runs:
  using: 'composite'
  steps:
    - name: Check Platform Support
      id: check-support
      shell: bash
      run: |
        echo "ğŸ” Checking platform support..."
        echo "ğŸ–¥ï¸  OS: ${{ runner.os }}"
        echo "ğŸ—ï¸  Architecture: ${{ runner.arch }}"
        
        # Check if platform is supported
        case "${{ runner.os }}-${{ runner.arch }}" in
          "macOS-X64")
            echo "âœ… macOS x86_64 is supported"
            ;;
          "macOS-ARM64")
            echo "âŒ macOS ARM64 is not supported"
            exit 1
            ;;
          "Windows-X64")
            echo "âœ… Windows x86_64 is supported"
            ;;
          "Windows-ARM64")
            echo "âŒ Windows ARM64 is not supported"
            exit 1
            ;;
          *)
            echo "âŒ Platform ${{ runner.os }}-${{ runner.arch }} is not supported"
            exit 1
            ;;
        esac

    # macOS - Use docker/setup-docker-action
    - name: ğŸ Install Docker on macOS
      if: runner.os == 'macOS'
      uses: docker/setup-docker-action@v4

    - name: ğŸ”— Ensure Docker is available in /usr/local/bin on macOS
      if: runner.os == 'macOS'
      shell: bash
      run: |
        echo "ğŸ”— Ensuring Docker is available in /usr/local/bin..."
        if [[ ! -e "/usr/local/bin/docker" ]]; then
          echo "Creating Docker symlink for persistent access..."
          sudo ln -s $(which docker) /usr/local/bin/docker
          echo "âœ… Docker symlink created: /usr/local/bin/docker -> $(which docker)"
        else
          echo "â„¹ï¸ Docker already available at /usr/local/bin/docker"
        fi

    # Windows - Setup WSL and install Docker
    - name: ğŸªŸ Setup WSL for Windows
      if: runner.os == 'Windows'
      uses: Vampire/setup-wsl@v6
      with:
        distribution: Ubuntu-24.04
        wsl-shell-user: ubuntu
        wsl-conf: |
          [boot]
          systemd=true
          
          [interop]
          enabled=true
          appendWindowsPath=true
          
          [network]
          generateResolvConf=true

    - name: ğŸ³ Install Docker in WSL
      if: runner.os == 'Windows'
      shell: wsl-bash {0}
      run: |
        echo "ğŸ”„ Updating package index..."
        sudo apt-get update
        
        echo "ğŸ“¦ Installing required packages..."
        sudo apt-get install -y ca-certificates curl gnupg lsb-release
        
        echo "ğŸ”‘ Adding Docker GPG key..."
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        
        echo "ğŸ“‹ Adding Docker repository..."
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        echo "ğŸ”„ Updating package index with Docker repo..."
        sudo apt-get update
        
        echo "ğŸ³ Installing Docker..."
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
        
        echo "ğŸ”§ Extending docker.socket to support TCP..."
        sudo mkdir -p /etc/systemd/system/docker.socket.d
        sudo tee /etc/systemd/system/docker.socket.d/tcp-listen.conf > /dev/null <<EOF
        [Socket]
        ListenStream=2375
        EOF
        
        echo "ğŸš€ Starting Docker services..."
        sudo systemctl daemon-reload
        
        # Stop services to apply changes
        sudo systemctl stop docker || true
        sudo systemctl stop docker.socket || true
        
        # Start services
        sudo systemctl start docker.socket
        sudo systemctl start docker
        
        echo "ğŸ‘¤ Adding user to docker group..."
        sudo usermod -aG docker ubuntu
        
        echo "âœ… Docker installation completed!"
        
        # Test Docker installation
        echo "ğŸ§ª Testing Docker installation..."
        sudo docker --version
        sudo docker info

        echo "ğŸŒ Testing both Unix and TCP sockets..."
        curl -s http://localhost:2375/version || echo "TCP socket not ready yet"

    # Set Docker Host environment variable
    - name: ğŸ”§ Set Docker Host
      id: set-docker-host
      shell: bash
      run: |
        case "${{ runner.os }}" in
          "Windows")
            docker_host="tcp://localhost:2375"
            setx DOCKER_HOST "tcp://localhost:2375"
            echo "DOCKER_HOST=${docker_host}" >> $GITHUB_ENV
            echo "docker-host=${docker_host}" >> $GITHUB_OUTPUT
            echo "ğŸŒ DOCKER_HOST set to: ${docker_host}"
            ;;
          "macOS"|"Linux")
            docker_host="unix:///var/run/docker.sock"
            echo "docker-host=${docker_host}" >> $GITHUB_OUTPUT
            echo "ğŸŒ DOCKER_HOST using default: ${docker_host}"
            ;;
        esac

    # Test Docker installation (except for unsupported platforms)
    - name: ğŸ§ª Test Docker Installation
      if: steps.check-support.outputs.supported == 'true'
      shell: bash
      run: |
        echo "ğŸ§ª Testing Docker installation..."
        
        # For Windows, test via WSL
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "ğŸªŸ Testing Docker in WSL..."
          wsl -d Ubuntu-24.04 -u ubuntu -- docker --version
          echo "âœ… Docker is working in WSL!"
        else
          echo "ğŸ³ Testing Docker directly..."
          docker --version
          docker info
          echo "ğŸ” Docker binary location: $(which docker)"
          echo "âœ… Docker is working!"
        fi

    - name: Setup tmate session
      if: ${{ failure() }}
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true